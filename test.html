<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test vim</title>
</head>

<body>
    <input type="text">

    <script>
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZáéíóöőúüűzabcdefghijklmnopqrstuvwxyzÁÉÍÓÖŐÚÜŰ 1234567890!@#$%^&*()-=_+[]\\{}|;':.";
        const digits = "0123456789";

        let MODE = "n"; // MODE = "n"|"v"|"i"
        let currentCommand = "";
        const moves = {
            "iden": (pos) => pos.index,

            // motions
            "h": (pos, count = 1) => pos.index - count,
            "l": (pos, count = 1) => pos.index + count,
            "b": (pos, count = 1) => pos.index - count * 5, // TODO: obviously
            "w": (pos, count = 1) => pos.index + count * 5, // TODO: obviously
            "e": (pos, count = 1) => pos.index + count * 5 - 2, // TODO: obviously
            "B": (pos, count = 1) => pos.index - count * 10, // TODO: obviously
            "W": (pos, count = 1) => pos.index + count * 10, // TODO: obviously
            "E": (pos, count = 1) => pos.index + count * 10 - 2, // TODO: obviously
            // ...

            // text objects
            "iw": (pos) => [this["b"](pos), this["e"](pos)],
            "iW": (pos) => [this["B"](pos), this["E"](pos)],
            // ...

            // helpers
            "fixedEnd": (pos) => pos.caret?.fixedEnd?.index,
            "position": (pos) => pos.index,
            // ...
        }

        const functions = {
            mode: (m) => {MODE = m; currentCommand = ""; console.log(`setting MODE to ${m}`)},
            insert: (text) => {console.log(`inserting ${text} at caret position(s)`)},
            delete: (getFrom, getTo) => {console.log(`deleting from ${getFrom} to ${getTo}`)},
            move: (getNewPos) => {console.log(`moving carets with the rule ${getNewPos}`)}, // if getNewPos returns one int, don't keep fixed end, if it returns [int], keep it, if it returns [int, int] set first int to fixedEnd, second to position
            removeCarets: () => {console.log("removing unnecessary carets");},
        };

        const parseCommand = (command) => { // command ~ "viW"
            console.log(`Parsing current command`);
            let headCommand;
            let headCommands = {"c": "change", "d": "delete"};
            if (MODE === "n" && headCommands[command[0]]) { // so that "d2e" and "diw" work
                headCommand = headCommands[command[0]];
                console.log("We have a headcommand!")
                command = command.slice(1);
            }

            let count = 0;
            while (!Number.isNaN(parseInt(command[0]))) {
                count = count * 10 + parseInt(command[0]);
                command = command.slice(1);
            }
            if (count === 0) count = 1;

            const iMotions = {
                "ArrowLeft": [["move", moves["h"]]],
                "ArrowRight": [["move", moves["l"]]],
                // ...

                "\\ABackspace": [["delete", moves["b"], moves["iden"]]],
            }

            if (MODE === "i") {
                // in insert mode, we can 
                // switch modes, 
                // insert some char from the abc, 
                // or move the caret like a regular keyboard
                if (command === "Escape" || command === "\\Cc") return [["mode", "n"]];
                if (abc.includes(command)) return [["insert", command]];
                if (iMotions[command]) return iMotions[command];
                return [];
            }

            const nModeChanges = {
                "i": [["mode", "i"]],
                "a": [["mode", "i"], ["move", moves["l"]]],
                "I": [["mode", "i"], ["move", moves["_"]]],
                "A": [["mode", "i"], ["move", moves["$"]]],
                "v": [["mode", "v"]],
                "Escape": [["removeCarets"]],
            }

            const nMoves = {
                // motions
                "h": [["move", moves["h"]]],
                "l": [["move", moves["l"]]],
                // ...

                // text objects
                "iw": [["move", moves["iw"]]],
                "aw": [["move", moves["aw"]]],
                "iW": [["move", moves["iW"]]],
                "aW": [["move", moves["aW"]]],
                "ip": [["move", moves["ip"]]],
                "ap": [["move", moves["ap"]]],
                "i(": [["move", moves["i("]]],
                "i)": [["move", moves["i("]]],
                // ...
            }

            if (MODE === "n") {
                // Mode changes
                if (headCommand == undefined && nModeChanges[command]) return nModeChanges[command];

                // Caret movements
                if (!headCommand) {
                    if (nMoves[command]) return nMoves[command];
                } else {
                    if (nMoves[command]) return [...nMoves[command], ["delete", moves["fixedEnd"], moves["position"]]]
                }

                return [];
            }
        }

        const runCurrentCommand = () => {
            console.log(`Running currentCommand in MODE ${MODE}`);
            let commandsToRun = parseCommand(currentCommand);
            console.log(`Commands to run: ${commandsToRun}`);
            for (let c of commandsToRun) functions[c[0]](...c.slice(1));
            console.log(`Commands ran`);
            return commandsToRun.length > 0;
        }

        const appendCurrentCommand = (letter) => { // letter ~ \\Co, i, \\M\\AArrowLeft
            console.log(`Appending ${letter} to currentCommand`);
            currentCommand += letter;
            console.log(`CurrentCommand: ${currentCommand}`);
            if (runCurrentCommand()) currentCommand = "";
        }

        document.addEventListener("keydown", e => {
            console.log(e);
            if (["Meta", "Alt", "Control"].includes(e.key)) return;

            let letter = e.key;
            if (e.ctrlKey) letter = "\\C" + letter;
            if (e.altKey) letter = "\\A" + letter;
            if (e.metaKey) letter = "\\M" + letter;

            appendCurrentCommand(letter);
        });
    </script>
</body>

</html>
